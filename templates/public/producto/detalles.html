{% extends "public/base.html" %}
{% load static %}

{% block title %}Detalles – {{ producto.nombre }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'public/detalles_producto/css/main.css' %}">
{% endblock %}

{% block content %}
<section class="detalle-section">

  <!-- Flecha para volver -->
  <a href="{% url 'coleccion_genero' origen %}" class="volver-atras" aria-label="Volver">
    <svg class="chevron" width="10" height="10" viewBox="0 0 10 6"
         fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M1 1L5 5L9 1"
            stroke="#1D1D1D" stroke-width="0.5"
            stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </a>

  <div class="detalle-container">

    <!-- ── Carrusel de Imágenes ── -->
    <div class="detalle-imagen">
      <div class="carrusel-container">
        <div class="carrusel-viewport">
          <div class="carrusel-track" id="carrusel-track">
            <!-- Imágenes del producto base -->
            {% for img_url in imagenes_producto %}
              <div class="carrusel-slide">
                <img src="{{ img_url }}" alt="{{ producto.nombre }}" class="slide-img">
              </div>
            {% empty %}
              <div class="carrusel-slide">
                <img src="https://via.placeholder.com/400x400?text=Sin+imagen" alt="{{ producto.nombre }}" class="slide-img">
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Botones de navegación -->
        <button class="carrusel-btn carrusel-btn-prev" id="carrusel-prev" aria-label="Imagen anterior">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button class="carrusel-btn carrusel-btn-next" id="carrusel-next" aria-label="Imagen siguiente">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>

        <!-- Indicadores (dots) -->
        <div class="carrusel-dots" id="carrusel-dots">
          <!-- Se llena dinámicamente con JavaScript -->
        </div>
      </div>
    </div>

    <!-- ── Información ── -->
    <div class="detalle-info">
      <p class="sku">{{ producto.id|stringformat:"03d" }}</p>
      <h2>{{ producto.nombre }}</h2>
      <h3 id="precio-actual">${{ producto.precio|floatformat:2 }}</h3>

      <!-- Selector de color -->
      {% if colores|length > 1 %}
      <label for="select-color">Color:</label>
      <select id="select-color">
        <option value="">Seleccionar color</option>
        {% for c in colores %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
      {% elif colores %}
      <input type="hidden" id="select-color" value="{{ colores.0 }}">
      {% endif %}

      <!-- Selector de talla -->
      <label for="select-talla-inicial">Elige tu talla:</label>
      <select id="select-talla-inicial">
        <option value="">Seleccionar talla</option>
        {% for t in tallas %}
          <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
      </select>

      <!-- Contenedor de líneas dinámicas -->
      <div id="lineas-tallas"></div>

      <!-- Selector extra (oculto hasta crear 1ª línea) -->
      <div id="wrapper-select-extra" style="display:none; margin-top:10px;">
        <select id="select-talla-extra">
          <option value="">Añadir Talla </option>
          {% for t in tallas %}
            <option value="{{ t }}">{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <p id="info-stock" style="display: none;"></p>

      <p>Sujeto a Disponibilidad</p>

      <a href="#" class="guia-tallas">Guía de tallas</a>

      <p class="descripcion">{{ producto.descripcion }}</p>
      <br>
      <!-- Botón acción -->
      <button class="btn-asesor" id="btn-agregar-carrito"> Agregar al carrito</button>

    </div>

  </div>
</section>

<!-- Toast overlay minimalista -->
<div id="toast-overlay" class="toast-overlay">
  <div class="toast-content">
    <span id="toast-text"></span>
  </div>
</div>

<!-- Datos para JS -->
<div id="detalles-datos"
     data-cliente-id="{{ request.session.cliente_id }}"
     data-producto-id="{{ producto.id }}"></div>

<!-- Variantes JSON -->
<script id="variantes-data" type="application/json">
  {{ variantes_json|safe }}
</script>
{% endblock %}

{% block extra_js %}
  <script>
    window.SESSION_KEY = "{{ request.session.session_key|default:'' }}";
  </script>
  <script src="{% static 'public/detalles_producto/js/carrusel.js' %}"></script>
  <script src="{% static 'public/detalles_producto/js/main.js' %}"></script>
{% endblock %}

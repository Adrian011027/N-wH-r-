{% extends "public/base.html" %}
{% load static %}

{% block title %}Mi Carrito - NöwHėrē{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'public/carrito/css/carrito.css' %}">
{% endblock %}

{% block content %}
<div class="carrito-page">
  
  <!-- Header de la página -->
  <div class="carrito-page-header">
    <a href="{% url 'index' %}" class="carrito-back-link">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Seguir comprando
    </a>
    <h1>Mi Carrito</h1>
  </div>

  <!-- Alerta de mayoreo -->
  <div id="alerta-meta-mayoreo" class="carrito-alert carrito-alert-info" style="display: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 16v-4M12 8h.01"/>
    </svg>
    <span>Te faltan <strong class="piezas-restantes">4</strong> piezas para precio de mayoreo</span>
  </div>

  <div id="alerta-mayoreo" class="carrito-alert carrito-alert-success" style="display: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
    </svg>
    <span>¡Precio de <strong>mayoreo</strong> aplicado!</span>
  </div>

  <!-- Layout principal -->
  <div class="carrito-layout" id="carrito-activo">
    
    <!-- Columna izquierda: Productos -->
    <div class="carrito-productos-col">
      <div class="carrito-section-card">
        <div class="carrito-section-header">
          <span class="carrito-section-title">Productos</span>
          <span class="carrito-count" id="carrito-count">0 artículos</span>
        </div>
        
        <div class="carrito-items-list" id="carrito-items">
          <!-- Items inyectados por JS -->
        </div>

        <!-- Vaciar carrito -->
        <div class="carrito-vaciar-wrapper" id="vaciar-wrapper">
          <button type="button" class="btn-vaciar-carrito btn-vaciar">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Vaciar carrito
          </button>
        </div>
      </div>
    </div>

    <!-- Columna derecha: Resumen -->
    <div class="carrito-resumen-col" id="resumen-col">
      <div class="carrito-section-card carrito-resumen-card">
        <div class="carrito-section-header">
          <span class="carrito-section-title">Resumen del pedido</span>
        </div>

        <div class="carrito-resumen-content">
          <div class="resumen-row">
            <span>Subtotal</span>
            <span id="carrito-subtotal">$0</span>
          </div>
          <div class="resumen-row">
            <span>Envío</span>
            <span class="resumen-envio-text">Calcular en siguiente paso</span>
          </div>
          <div class="resumen-row resumen-total">
            <span>Total</span>
            <strong id="resumen-total">$0</strong>
          </div>
          
          <button type="button" class="btn-checkout" id="btn-checkout">
            Continuar al pago
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
        </div>

        <div class="carrito-seguridad">
          <div class="seguridad-item">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <span>Pago seguro</span>
          </div>
          <div class="seguridad-item">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            <span>Datos protegidos</span>
          </div>
          <div class="seguridad-item">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            <span>Múltiples métodos</span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Vista carrito vacío -->
  <div id="carrito-vacio" class="carrito-empty-state" style="display: none;">
    <div class="empty-icon">
      <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1">
        <circle cx="9" cy="21" r="1"/>
        <circle cx="20" cy="21" r="1"/>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
      </svg>
    </div>
    <h2>Tu carrito está vacío</h2>
    <p id="carrito-msg">Añade productos para verlos aquí</p>
    <a href="{% url 'index' %}" class="btn-explorar" id="carrito-cta">
      Explorar productos
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="5" y1="12" x2="19" y2="12"/>
        <polyline points="12 5 19 12 12 19"/>
      </svg>
    </a>
  </div>

</div>
{% endblock %}

{% block footer %}
<!-- Footer oculto en página de carrito -->
{% endblock %}

{% block extra_js %}
<script>
  const CLIENTE_ID = localStorage.getItem("user_id") || 0;
  const TOKEN = localStorage.getItem("access");
  const IS_LOGGED = !!TOKEN;

  document.addEventListener("DOMContentLoaded", () => {
    const msg = document.getElementById("carrito-msg");
    const cta = document.getElementById("carrito-cta");

    if (!IS_LOGGED) {
      msg.textContent = "Inicia sesión para ver tu carrito";
      cta.textContent = "Iniciar sesión";
      cta.href = "#";
      cta.onclick = (e) => {
        e.preventDefault();
        if (typeof mostrarLoginPanel === 'function') mostrarLoginPanel();
      };
    }
  });
</script>
<script src="{% static 'public/carrito/js/carrito.js' %}"></script>
{% endblock %}
